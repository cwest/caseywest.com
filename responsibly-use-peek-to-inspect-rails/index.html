<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Responsibly Use Peek to Inspect Rails &#8211; The consensus-seeking architect.</title>
<meta name="description" content="Use these tips to keep Peek out of production.">
<meta name="keywords" content="ruby, rails">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://caseywest.com/images/feature/santa-cruz-beach.jpg">

<meta name="twitter:title" content="Responsibly Use Peek to Inspect Rails">
<meta name="twitter:description" content="Use these tips to keep Peek out of production.">
<meta name="twitter:creator" content="@caseywest">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Responsibly Use Peek to Inspect Rails">
<meta property="og:description" content="Use these tips to keep Peek out of production.">
<meta property="og:url" content="http://caseywest.com/responsibly-use-peek-to-inspect-rails/">
<meta property="og:site_name" content="The consensus-seeking architect.">





<link rel="canonical" href="http://caseywest.com/responsibly-use-peek-to-inspect-rails/">
<link href="http://caseywest.com/feed.xml" type="application/atom+xml" rel="alternate" title="The consensus-seeking architect. Feed">
<link rel="author" href="https://google.com/+CaseyWest412?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://caseywest.com/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic|Source+Code+Pro" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://caseywest.com/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 32x32 -->
<link rel="shortcut icon" href="http://caseywest.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://caseywest.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://caseywest.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://caseywest.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://caseywest.com/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://caseywest.com/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://caseywest.com/images/avatar.jpg" alt="Casey West photo" class="author-photo">
					<h4>Casey West</h4>
					<p>I have a lot to say.</p>
				</li>
				<li><a href="http://caseywest.com/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				
				<li>
					<a href="http://twitter.com/caseywest"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://facebook.com/caseywest"><i class="fa fa-facebook"></i> Facebook</a>
				</li>
				<li>
					<a href="https://google.com/+CaseyWest412"><i class="fa fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="http://linkedin.com/in/caseywest"><i class="fa fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/cwest"><i class="fa fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="http://instagram.com/caseyrwest"><i class="fa fa-instagram"></i> Instagram</a>
				</li>
				<li>
					<a href="http://www.flickr.com/photos/caseywest"><i class="fa fa-flickr"></i> Flickr</a>
				</li>
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://caseywest.com/posts/">All Posts</a></li>
				<li><a href="http://caseywest.com/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="http://caseywest.com/images/feature/santa-cruz-beach.jpg" alt="Responsibly Use Peek to Inspect Rails">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://caseywest.com/responsibly-use-peek-to-inspect-rails/" rel="bookmark" title="Responsibly Use Peek to Inspect Rails">Responsibly Use Peek to Inspect Rails</a></h1>
        
        <h2>January 07, 2015</h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~10 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>I <em>love</em> developing applications with the <a href="https://github.com/peek/peek">peek</a> gem. It's designed for development or staging environments; there are a few tricks if you don't want it on production or test environments.</p>

<p>This gem puts a little bar on your pages which gives you all sorts of helpful information about the request you just made.</p>

<p><img src="https://f.cloud.github.com/assets/79995/244991/03cee1fa-8a74-11e2-8e33-283cf1298a60.png" alt="peek screenshot" /></p>

<p>As you can see there is information about the branch you're on, performance metrics, database queries, caches, shared memory, and job queues in there. Read the documentation for <a href="https://github.com/peek/peek">peek</a> on GitHub and find the plugins that work best for you. They're excellent.</p>

<p><span class="pullquote-right" data-pullquote="I definitely don&apos;t want to install Peek on production">
The trouble is I definitely don't want to install Peek on production, or in my test environments, and the <a href="https://github.com/peek/peek/blob/master/README.md#usage">peek usage</a> instructions would, indeed, require me to do so for a few key reasons: initializers, routes, assets, and views. Using peek requires a few steps of setup in your application. Each of the areas I enumerated requires peek to be a loaded gem in the environment you're running on.
</span></p>

<p>My first attempt to work around this involved wrapping calls with a <a href="http://ruby-doc.org/docs/keywords/1.9/Object.html#method-i-defined-3F"><code>defined?</code></a> test. For example, in <code>config/routes.rb</code>:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre>mount <span class="constant">Peek</span>::<span class="constant">Railtie</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">/peek</span><span class="delimiter">'</span></span> <span class="keyword">if</span> <span class="keyword">defined?</span>(<span class="constant">Peek</span>)
</pre></td>
</tr></table>
</div>

<p>To style and script peek bar you need some CSS and JavaScript assets as well, which are loaded through the asset pipeline. Problem is, if the gem isn't in your bundle those loads fail, and so does pre-compilation if you attempt it.</p>

<p>Finally, your views should be checking the <code>peek_enabled?</code> method, which is defined by peek in your <code>ApplicationController</code> class. So, for example, when rendering the peek bar itself you should be doing this:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>body
  = render <span class="string"><span class="delimiter">'</span><span class="content">peek/bar</span><span class="delimiter">'</span></span> <span class="keyword">if</span> peek_enabled?
</pre></td>
</tr></table>
</div>

<p>Again, if peek isn't in your Bundle, such as in the production environment, this render will fail.</p>

<p>I'm not particularly enthusiastic about this situation, so here is my guide to using peek responsibly. There are enough moving parts I decided to use the Table of Contents.</p>

<ul id="markdown-toc">
  <li><a href="#gemfile"><code>Gemfile</code></a></li>
  <li><a href="#peekbar-class"><code>PeekBar</code> Class</a>    <ul>
      <li><a href="#definition">Definition</a></li>
      <li><a href="#test">Test</a></li>
      <li><a href="#initialization">Initialization</a></li>
    </ul>
  </li>
  <li><a href="#peekbarhelper-module"><code>PeekBarHelper</code> Module</a>    <ul>
      <li><a href="#definition-1">Definition</a></li>
      <li><a href="#test-1">Test</a></li>
    </ul>
  </li>
  <li><a href="#peek-initialization"><code>Peek</code> Initialization</a></li>
  <li><a href="#assets">Assets</a>    <ul>
      <li><a href="#css-and-javascript-definition">CSS and JavaScript Definition</a></li>
      <li><a href="#initialization-1">Initialization</a></li>
      <li><a href="#default-assets-gotcha">Default Assets Gotcha</a></li>
    </ul>
  </li>
  <li><a href="#view-configuration">View Configuration</a></li>
  <li><a href="#finally">Finally</a></li>
</ul>

<h2 id="gemfile"><code>Gemfile</code></h2>

<p>Peek must be loaded into our environment. I'm loading it into my <code>:development</code> environment only, along with a list of Peek plugins I want to use.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>group <span class="symbol">:development</span> <span class="keyword">do</span>
  <span class="comment"># Peek Bar</span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">peek</span><span class="delimiter">'</span></span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">peek-git</span><span class="delimiter">'</span></span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">peek-gc</span><span class="delimiter">'</span></span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">peek-performance_bar</span><span class="delimiter">'</span></span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">peek-pg</span><span class="delimiter">'</span></span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<h2 id="peekbar-class"><code>PeekBar</code> Class</h2>

<p>This class is meant to answer two questions:</p>

<ol>
  <li><em>Is <code>Peek</code> available for use?</em> This question is asked when we start and configure the application.</li>
  <li><em>Should peek be enabled for this request?</em> This question is asked during requests. Specifically during view rendering for any view that incorporates peek, which is most likely a layout.</li>
</ol>

<h3 id="definition">Definition</h3>

<p>I put this class in <code>lib/peek_bar.rb</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">PeekBar</span>
  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">available?</span>
    !<span class="keyword">defined?</span>(<span class="constant">Peek</span>).nil?
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">enabled?</span>(current_user)
    <span class="keyword">return</span> <span class="predefined-constant">false</span> <span class="keyword">unless</span> available?

    <span class="comment"># The default test.</span>
    <span class="string"><span class="delimiter">%w(</span><span class="content">development staging</span><span class="delimiter">)</span></span>.include? <span class="constant">Rails</span>.env
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<p>Here you can see we've encapsulated the <code>defined?</code> test into <code>PeekBar.available?</code>. We use it in <code>PeekBar.enabled?</code> as the first test.</p>

<p>If peek is available, and we're in development or the <code>current_user</code> likes nerdy toys we enable peek.</p>

<h3 id="test">Test</h3>

<p>I use <a href="https://relishapp.com/rspec/rspec-rails/docs">rspec</a> for testing, so my spec is in <code>spec/lib/peek_bar_spec.rb</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
<a href="#n15" name="n15">15</a>
<a href="#n16" name="n16">16</a>
<a href="#n17" name="n17">17</a>
<a href="#n18" name="n18">18</a>
<a href="#n19" name="n19">19</a>
<strong><a href="#n20" name="n20">20</a></strong>
<a href="#n21" name="n21">21</a>
<a href="#n22" name="n22">22</a>
<a href="#n23" name="n23">23</a>
<a href="#n24" name="n24">24</a>
<a href="#n25" name="n25">25</a>
<a href="#n26" name="n26">26</a>
<a href="#n27" name="n27">27</a>
<a href="#n28" name="n28">28</a>
<a href="#n29" name="n29">29</a>
<strong><a href="#n30" name="n30">30</a></strong>
<a href="#n31" name="n31">31</a>
<a href="#n32" name="n32">32</a>
<a href="#n33" name="n33">33</a>
</pre></td>
  <td class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">rails_helper</span><span class="delimiter">'</span></span>

<span class="constant">RSpec</span>.describe <span class="constant">PeekBar</span> <span class="keyword">do</span>
  subject { described_class }

  context <span class="string"><span class="delimiter">'</span><span class="content">without Peek</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    before(<span class="symbol">:each</span>) <span class="keyword">do</span>
      <span class="constant">Object</span>.send(<span class="symbol">:remove_const</span>, <span class="symbol">:Peek</span>) <span class="keyword">if</span> <span class="keyword">defined?</span>(<span class="constant">Peek</span>)
    <span class="keyword">end</span>

    it <span class="string"><span class="delimiter">&quot;</span><span class="content">isn't available</span><span class="delimiter">&quot;</span></span> <span class="keyword">do</span>
      expect(subject.available?).to be(<span class="predefined-constant">false</span>)
    <span class="keyword">end</span>

    it <span class="string"><span class="delimiter">&quot;</span><span class="content">isn't enabled</span><span class="delimiter">&quot;</span></span> <span class="keyword">do</span>
      expect(subject.enabled?(anything)).to be(<span class="predefined-constant">false</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  context <span class="string"><span class="delimiter">'</span><span class="content">with Peek</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    before(<span class="symbol">:each</span>) { <span class="constant">Peek</span> = <span class="constant">Class</span>.new }
    after(<span class="symbol">:each</span>) { <span class="constant">Object</span>.send(<span class="symbol">:remove_const</span>, <span class="symbol">:Peek</span>) }

    it <span class="string"><span class="delimiter">'</span><span class="content">is available</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      expect(subject.available?).to be(<span class="predefined-constant">true</span>)
    <span class="keyword">end</span>

    it <span class="string"><span class="delimiter">'</span><span class="content">is enabled</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      allow(<span class="constant">Rails</span>.env).to receive(<span class="symbol">:development?</span>).and_return(<span class="predefined-constant">true</span>)
      expect(subject.enabled?(anything)).to be(<span class="predefined-constant">true</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<p>In order to ensure this test is isolated I take extra precautions to ensure the <code>Peek</code> constant isn't available to my tests unless I explicitly allow it.</p>

<h3 id="initialization">Initialization</h3>

<p>By default Rails doesn't load ruby code from the <code>lib/</code> directory, so lets be sure to tell it to. In <code>config/application.rb</code> add this:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>config.autoload_paths += <span class="string"><span class="delimiter">%W(</span><span class="content">
  </span><span class="inline"><span class="inline-delimiter">#{</span>config.root<span class="inline-delimiter">}</span></span><span class="content">/lib
</span><span class="delimiter">)</span></span>
</pre></td>
</tr></table>
</div>

<h2 id="peekbarhelper-module"><code>PeekBarHelper</code> Module</h2>

<p>As I said earlier peek implements a <code>peek_enabled?</code> method and suggests if you want to customize it define the method in your <code>ApplicationController</code> class. I recommend doing that in a helper class instead.</p>

<p>We need to know if peek should be enabled and to verify that we also need to know if it's available. With the <code>PeekBar</code> class this is simple.</p>

<h3 id="definition-1">Definition</h3>

<p>In <code>app/helpers/peek_bar_helper.rb</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre><span class="keyword">module</span> <span class="class">PeekBarHelper</span>
  <span class="comment"># Typical Peek Integration</span>
  <span class="keyword">def</span> <span class="function">peek_enabled?</span>
    <span class="constant">PeekBar</span>.enabled?(current_user)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<h3 id="test-1">Test</h3>

<p>Since we're programming responsibly here's a test for the helper. In <code>spec/helpers/peek_bar_helper_spec.rb</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
<a href="#n15" name="n15">15</a>
<a href="#n16" name="n16">16</a>
<a href="#n17" name="n17">17</a>
</pre></td>
  <td class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">rails_helper</span><span class="delimiter">'</span></span>

<span class="constant">RSpec</span>.describe <span class="constant">PeekBarHelper</span>, <span class="key">type</span>: <span class="symbol">:helper</span> <span class="keyword">do</span>
  before(<span class="symbol">:each</span>) <span class="keyword">do</span>
    allow(helper).to receive(<span class="symbol">:current_user</span>).and_return(anything)
  <span class="keyword">end</span>

  it <span class="string"><span class="delimiter">'</span><span class="content">is not enabled</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    allow(<span class="constant">PeekBar</span>).to receive(<span class="symbol">:enabled?</span>).and_return(<span class="predefined-constant">false</span>)
    expect(helper.peek_enabled?).to be(<span class="predefined-constant">false</span>)
  <span class="keyword">end</span>

  it <span class="string"><span class="delimiter">'</span><span class="content">is enabled</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    allow(<span class="constant">PeekBar</span>).to receive(<span class="symbol">:enabled?</span>).and_return(<span class="predefined-constant">true</span>)
    expect(helper.peek_enabled?).to be(<span class="predefined-constant">true</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<h2 id="peek-initialization"><code>Peek</code> Initialization</h2>

<p>The peek documentation explains how to set up <code>config/initializers/peek.rb</code> to enable the plugins you've selected. We need to first test for the availability of peek like this:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre><span class="keyword">if</span> <span class="constant">PeekBar</span>.available?
  <span class="constant">Peek</span>.into <span class="constant">Peek</span>::<span class="constant">Views</span>::<span class="constant">Git</span>
  <span class="constant">Peek</span>.into <span class="constant">Peek</span>::<span class="constant">Views</span>::<span class="constant">GC</span>
  <span class="constant">Peek</span>.into <span class="constant">Peek</span>::<span class="constant">Views</span>::<span class="constant">PerformanceBar</span>
  <span class="constant">Peek</span>.into <span class="constant">Peek</span>::<span class="constant">Views</span>::<span class="constant">PG</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<h2 id="assets">Assets</h2>

<p>We don't want to load or pre-compile the peek assets unless we intend to use them. My recommended approach is to wrap their inclusion in a new set of CSS and JavaScript files. I use the asset pipeline, so that's how I'll be including the gem's assets.</p>

<h3 id="css-and-javascript-definition">CSS and JavaScript Definition</h3>

<p>CSS is in <code>app/assets/stylesheets/peek_bar.scss</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
</pre></td>
  <td class="code"><pre>//= <span class="tag">require</span> <span class="tag">peek</span>
//= <span class="tag">require</span> <span class="tag">peek</span>/<span class="tag">views</span>/<span class="tag">performance_bar</span>

// <span class="tag">Peek</span> <span class="tag">bar</span> <span class="tag">on</span> <span class="tag">bottom</span> <span class="tag">of</span> <span class="tag">page</span>.
<span class="id">#peek</span> {
  <span class="key">position</span>: <span class="value">fixed</span>;
  <span class="key">bottom</span>:   <span class="float">0</span>;
  <span class="key">left</span>:     <span class="float">0</span>;
  <span class="key">right</span>:    <span class="float">0</span>;
  <span class="key">z-index</span>:  <span class="float">999</span>;
}
</pre></td>
</tr></table>
</div>

<p>I prefer <a href="http://coffeescript.org/">CoffeeScript</a> so I loaded the JavaScript in <code>app/assets/javascripts/peek_bar.js.coffee</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>#= require peek
#= require peek/views/performance_bar
</pre></td>
</tr></table>
</div>

<h3 id="initialization-1">Initialization</h3>

<p>The asset pipeline complains if you don't tell it about additional assets you intend to include separately (see the next section on <a href="#view-configuration">View Configuration</a>). Thing is, we don't <em>always</em> intend to include them or pre-compile them in this case. Just like when we initialized peek itself we must check for its availability.</p>

<p>Add this to <code>config/initializers/assets.rb</code>:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre><span class="keyword">if</span> <span class="constant">PeekBar</span>.available?
  <span class="constant">Rails</span>.application.config.assets.precompile += <span class="string"><span class="delimiter">%w(</span><span class="content">peek_bar.css peek_bar.js</span><span class="delimiter">)</span></span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<h3 id="default-assets-gotcha">Default Assets Gotcha</h3>

<p>By default <code>application.css</code> and <code>application.js</code> include all the CSS and JavaScript in their respective directory trees. That's achieved through the use of <code>require_tree .</code> in each of those files.</p>

<p>Now that we've created a couple assets to conditionally load we need to remove <code>require_tree</code>. If you don't remove it your default assets will try to include <code>peek_bar.*</code> which will lead to the aforementioned failures on environments where peek is not installed.</p>

<p>If you were relying on it, which I don't recommend for reasons beyond the scope of this essay, learn how to deal with it by reading the <a href="http://guides.rubyonrails.org/asset_pipeline.html#manifest-files-and-directives">Asset Pipeline Rails Guide</a>.</p>

<h2 id="view-configuration">View Configuration</h2>

<p>All this hard work for what? Now it's time to tie it all together in our layout view. I like <a href="http://slim-lang.com/">slim</a> so this is an extremely condensed version of my default layout, <code>app/views/layouts/application.html.slim</code>.</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
</pre></td>
  <td class="code"><pre>doctype html
html
  head
    = stylesheet_link_tag <span class="string"><span class="delimiter">'</span><span class="content">application</span><span class="delimiter">'</span></span>, <span class="key">media</span>: <span class="string"><span class="delimiter">'</span><span class="content">all</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">data-turbolinks-track</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">true</span>
    - <span class="keyword">if</span> peek_enabled?
      = stylesheet_link_tag <span class="string"><span class="delimiter">'</span><span class="content">peek_bar</span><span class="delimiter">'</span></span>, <span class="key">media</span>: <span class="string"><span class="delimiter">'</span><span class="content">all</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">data-turbolinks-track</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">true</span>
    = csrf_meta_tags
body
  = render <span class="string"><span class="delimiter">'</span><span class="content">peek/bar</span><span class="delimiter">'</span></span> <span class="keyword">if</span> peek_enabled?
  = <span class="keyword">yield</span>
  = javascript_include_tag <span class="string"><span class="delimiter">'</span><span class="content">application</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">data-turbolinks-track</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">true</span>
  - <span class="keyword">if</span> peek_enabled?
    = javascript_include_tag <span class="string"><span class="delimiter">'</span><span class="content">peek_bar</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">data-turbolinks-track</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">true</span>
</pre></td>
</tr></table>
</div>

<h2 id="finally">Finally</h2>

<p>Voila!</p>

<p>At this point <a href="https://github.com/peek/peek">peek</a> is incorporated into my application in a robust, responsible way. Environments we didn't install it into operate perfectly without it, and the ones we do have an encapsulation to use for managing its inclusion in our interface.</p>

<p>It was a little more work but it paid off. We have an excellent developer tool installed without hurting production.</p>

<p>If we want to use peek in production with only staff accounts, for example, all we have to do is change the <code>Gemfile</code> to install peek in the <code>:production</code> group and adjust the <code>PeekBar.enabled?</code> method:</p>

<div class="highlighter-coderay"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">enabled?</span>(current_user)
  <span class="keyword">return</span> <span class="predefined-constant">false</span> <span class="keyword">unless</span> available?

  <span class="constant">Rails</span>.env.development? || current_user.staff?
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div>

<p>That <code>PeekBar</code> class really tied the room together, did it not?</p>

<iframe width="560" height="315" src="http://www.youtube.com/embed/ezQLP1dj_t8" allowfullscreen=""></iframe>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://caseywest.com/tags/#ruby" title="Pages tagged ruby" class="tag">ruby</a><a href="http://caseywest.com/tags/#rails" title="Pages tagged rails" class="tag">rails</a></span>
        <span><a href="http://caseywest.com/responsibly-use-peek-to-inspect-rails/" rel="bookmark" title="Responsibly Use Peek to Inspect Rails">Responsibly Use Peek to Inspect Rails</a> was published on <span class="entry-date date published updated"><time datetime="2015-01-07T00:00:00-05:00">January 07, 2015</time></span></span>
        (revised: <span class="entry-date date modified"><time datetime="2015-01-07 21:51:33 -0500">01/07/2015</time></span>)
        <span class="author vcard"><span class="fn"><a href="http://caseywest.com/about/" title="About Casey West">Casey West</a></span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="reddit"><a href="https://www.reddit.com/submit?url=http://caseywest.com/responsibly-use-peek-to-inspect-rails/&title=Responsibly+Use+Peek+to+Inspect+Rails" title="Submit on Reddit"><span class="count"><i class="fa fa-reddit-square"></i> Submit</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=Responsibly+Use+Peek+to+Inspect+Rails%20%E2%80%94%C2%A0http://caseywest.com/responsibly-use-peek-to-inspect-rails/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=Responsibly+Use+Peek+to+Inspect+Rails%20%E2%80%94%C2%A0http://caseywest.com/responsibly-use-peek-to-inspect-rails/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=Responsibly+Use+Peek+to+Inspect+Rails%20%E2%80%94%C2%A0http://caseywest.com/responsibly-use-peek-to-inspect-rails/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://caseywest.com/faster-ci-on-travis-and-docker-for-ruby-and-rails-and-rubocop/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://caseywest.com/work-with-us-at-whitehat/" title="Work with us at WhiteHat">Work with us at WhiteHat</a></h3>
      <p>Join our happy team of developers in Pittsburgh. <a href="http://caseywest.com/work-with-us-at-whitehat/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://caseywest.com/faster-ci-on-travis-and-docker-for-ruby-and-rails-and-rubocop/" title="Faster CI on Travis (and Docker) for Ruby (and Rails (and RuboCop))">Faster CI on Travis (and Docker) for Ruby (and Rails (and RuboCop))</a></h4>
        <span>Published on January 06, 2015</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://caseywest.com/theres-still-no-silver-bullet/" title="There's Still No Silver Bullet (2006)">There's Still No Silver Bullet (2006)</a></h4>
        <span>Published on January 04, 2015</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->

  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <p><span>&copy; 2015 Casey West.</span></p>
<p class="attribution"><span>Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://caseywest.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://caseywest.com/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57986008-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>




<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</body>
</html>
